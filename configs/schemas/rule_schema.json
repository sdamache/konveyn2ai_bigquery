{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://konveyn2ai.com/schemas/rule_schema.json",
  "title": "Gap Analysis Rule Configuration Schema",
  "description": "JSON Schema for validating gap analysis rule definitions across all artifact types",
  "type": "object",
  "required": [
    "rule_name",
    "artifact_type", 
    "version",
    "evaluation_sql",
    "confidence_weights",
    "severity",
    "suggested_fix_template"
  ],
  "properties": {
    "rule_name": {
      "type": "string",
      "pattern": "^[a-z0-9_]+$",
      "minLength": 3,
      "maxLength": 50,
      "description": "Unique identifier for the rule (lowercase, underscores, alphanumeric)"
    },
    "artifact_type": {
      "type": "string",
      "enum": ["kubernetes", "fastapi", "cobol", "irs", "mumps"],
      "description": "Type of artifact this rule applies to"
    },
    "version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "description": "Semantic version (X.Y.Z) of the rule"
    },
    "description": {
      "type": "string",
      "minLength": 10,
      "maxLength": 500,
      "description": "Human-readable description of what the rule validates"
    },
    "evaluation_sql": {
      "type": "string",
      "minLength": 50,
      "description": "Parameterized BigQuery SQL for rule evaluation"
    },
    "confidence_weights": {
      "type": "object",
      "description": "Weight factors for confidence calculation components",
      "patternProperties": {
        "^[a-z_]+$": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        }
      },
      "additionalProperties": false,
      "minProperties": 1
    },
    "severity": {
      "type": "integer",
      "minimum": 1,
      "maximum": 5,
      "description": "Impact severity: 1=low, 2=moderate, 3=medium, 4=high, 5=critical"
    },
    "suggested_fix_template": {
      "type": "string",
      "minLength": 10,
      "maxLength": 500,
      "description": "Mustache template for actionable remediation guidance"
    },
    "enabled": {
      "type": "boolean",
      "default": true,
      "description": "Whether this rule is active in evaluation"
    },
    "tags": {
      "type": "array",
      "items": {
        "type": "string",
        "pattern": "^[a-z0-9_-]+$"
      },
      "uniqueItems": true,
      "description": "Tags for rule categorization and filtering"
    },
    "quality_thresholds": {
      "type": "object",
      "description": "Quality assessment thresholds",
      "properties": {
        "min_content_length": {
          "type": "integer",
          "minimum": 1,
          "description": "Minimum required content length"
        },
        "required_fields": {
          "type": "array", 
          "items": {
            "type": "string"
          },
          "description": "List of fields that must be present"
        },
        "field_patterns": {
          "type": "object",
          "patternProperties": {
            "^[a-z_]+$": {
              "type": "string",
              "description": "Regex pattern for field validation"
            }
          }
        }
      },
      "additionalProperties": false
    },
    "metadata": {
      "type": "object",
      "description": "Additional rule metadata",
      "properties": {
        "author": {
          "type": "string",
          "description": "Rule author or team"
        },
        "created_date": {
          "type": "string",
          "format": "date",
          "description": "Rule creation date (YYYY-MM-DD)"
        },
        "last_modified": {
          "type": "string", 
          "format": "date",
          "description": "Last modification date (YYYY-MM-DD)"
        },
        "review_frequency": {
          "type": "string",
          "enum": ["monthly", "quarterly", "annually"],
          "description": "How often the rule should be reviewed"
        },
        "related_rules": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Names of related or dependent rules"
        }
      },
      "additionalProperties": false
    }
  },
  "additionalProperties": false,
  "allOf": [
    {
      "description": "Confidence weights must sum to 1.0",
      "if": {
        "properties": {
          "confidence_weights": {
            "type": "object"
          }
        }
      },
      "then": {
        "properties": {
          "confidence_weights": {
            "additionalProperties": {
              "type": "number"
            }
          }
        }
      }
    }
  ],
  "examples": [
    {
      "rule_name": "kubernetes_deployment_description",
      "artifact_type": "kubernetes",
      "version": "1.0.0",
      "description": "Validates that Kubernetes Deployments have proper documentation",
      "evaluation_sql": "SELECT chunk_id, CASE WHEN JSON_EXTRACT_SCALAR(metadata, '$.annotations.description') IS NOT NULL THEN true ELSE false END as passed FROM source_metadata WHERE artifact_type = 'kubernetes' AND kind = 'Deployment'",
      "confidence_weights": {
        "description_present": 0.7,
        "content_length": 0.3
      },
      "severity": 3,
      "suggested_fix_template": "Add description annotation: metadata.annotations.description = '{{description_suggestion}}'",
      "enabled": true,
      "tags": ["documentation", "kubernetes", "best_practices"],
      "quality_thresholds": {
        "min_content_length": 10,
        "required_fields": ["metadata.annotations.description"]
      },
      "metadata": {
        "author": "platform-team",
        "created_date": "2025-01-09",
        "review_frequency": "quarterly"
      }
    }
  ]
}